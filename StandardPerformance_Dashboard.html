<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Standard Performance AI Survey - Executive Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* =============================================================================
   CSS VARIABLES & RESET
   ============================================================================= */
:root{
    --primary:#1565C0;
    --primary-dark:#0D47A1;
    --dark:#2D2D2D;
    --gray:#666;
    --light:#E8E8E8;
    --bg:#F5F5F5;
    --green:#28a745;
    --orange:#FF9800;
    --blue:#2196F3;
    --purple:#7B1FA2;
    --red:#C8102E;
    --accent-light:#E3F2FD
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Prompt',sans-serif;background:var(--bg);color:var(--dark);font-size:14px;line-height:1.5}
.container{max-width:1400px;margin:0 auto;padding:20px}

/* =============================================================================
   HEADER
   ============================================================================= */
.header{
    background:linear-gradient(135deg,var(--primary),var(--primary-dark));
    color:#fff;
    padding:24px;
    border-radius:16px;
    margin-bottom:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:15px
}
.header h1{font-size:1.4rem;display:flex;align-items:center;gap:10px}
.header p{opacity:.9;font-size:.85rem}
.header-stats{display:flex;gap:30px}
.header-stat{text-align:center}
.header-stat-value{font-size:1.8rem;font-weight:700}
.header-stat-label{font-size:.75rem;opacity:.85}

/* =============================================================================
   STATUS BAR
   ============================================================================= */
.status-bar{
    background:#fff;
    padding:12px 20px;
    border-radius:12px;
    margin-bottom:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:10px;
    box-shadow:0 2px 8px rgba(0,0,0,.06)
}
.status-item{display:flex;align-items:center;gap:8px;font-size:.85rem}
.status-dot{width:10px;height:10px;border-radius:50%;background:#ccc}
.status-dot.online{background:var(--green);animation:pulse 2s infinite}
.status-dot.loading{background:var(--orange);animation:pulse 1s infinite}
.status-dot.error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* =============================================================================
   FILTER BAR
   ============================================================================= */
.filter-bar{
    background:#fff;
    padding:15px 20px;
    border-radius:12px;
    margin-bottom:20px;
    display:flex;
    gap:15px;
    flex-wrap:wrap;
    align-items:center;
    box-shadow:0 2px 8px rgba(0,0,0,.06)
}
.filter-group{display:flex;align-items:center;gap:8px}
.filter-group label{font-weight:500;font-size:.85rem;color:var(--gray)}
select,input[type=text]{padding:8px 12px;border:2px solid var(--light);border-radius:8px;font-family:inherit;font-size:.85rem}
select:focus,input:focus{outline:none;border-color:var(--primary)}
.btn{padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:500;cursor:pointer;transition:background .2s}
.btn:hover{background:var(--primary-dark)}
.btn.sec{background:var(--light);color:var(--dark)}
.btn.sec:hover{background:#ddd}

/* =============================================================================
   KPI ROW
   ============================================================================= */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:15px;margin-bottom:20px}
.kpi{background:#fff;padding:18px;border-radius:12px;text-align:center;border-left:4px solid var(--primary);box-shadow:0 2px 8px rgba(0,0,0,.06)}
.kpi.green{border-left-color:var(--green)}
.kpi.blue{border-left-color:var(--blue)}
.kpi.orange{border-left-color:var(--orange)}
.kpi.red{border-left-color:var(--red)}
.kpi-value{font-size:1.6rem;font-weight:700}
.kpi-label{font-size:.8rem;color:var(--gray);margin-top:4px}
.kpi-hint{font-size:.7rem;margin-top:6px;padding:2px 8px;border-radius:12px;display:inline-block;background:var(--accent-light);color:var(--primary)}
.kpi-hint.warning{background:#FFF3E0;color:var(--orange)}
.kpi-hint.danger{background:#FFEBEE;color:var(--red)}

/* =============================================================================
   GRID & CARDS
   ============================================================================= */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden}
.card.full{grid-column:1/-1}
.card-header{padding:14px 18px;border-bottom:1px solid var(--light);display:flex;align-items:center;gap:10px}
.card-badge{width:28px;height:28px;background:var(--primary);color:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.8rem}
.card-title h3{font-size:.9rem;font-weight:600}
.card-title p{font-size:.7rem;color:var(--gray)}
.card-body{padding:18px}

/* =============================================================================
   DEPARTMENT SNAPSHOT (Card A)
   ============================================================================= */
.dept-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
.dept-card{padding:10px;background:var(--bg);border-radius:8px;text-align:center;border-left:3px solid var(--primary)}
.dept-card .dept-name{font-size:.75rem;font-weight:500;margin-bottom:4px}
.dept-card .dept-count{font-size:1.2rem;font-weight:700;color:var(--primary)}

/* =============================================================================
   TEAM COMPARISON (Legacy - kept for compatibility)
   ============================================================================= */
.team-compare{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
/* =============================================================================
   LEVEL DISTRIBUTION (Card B1)
   ============================================================================= */
.level-bars{display:flex;flex-direction:column;gap:8px}
.level-item{display:flex;align-items:center;gap:10px}
.level-badge{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.75rem}
.l0{background:#E0E0E0}.l1{background:#FFCDD2}.l2{background:#FFAB91}.l3{background:#FFE082}.l4{background:#A5D6A7}.l5{background:#4CAF50;color:#fff}
.level-info{flex:1}
.level-top{display:flex;justify-content:space-between;font-size:.75rem;margin-bottom:3px}
.level-count{font-weight:600;color:var(--primary)}
.level-track{height:6px;background:var(--light);border-radius:3px;overflow:hidden}
.level-fill{height:100%;border-radius:3px}

/* =============================================================================
   TOOL ADOPTION (Card B2)
   ============================================================================= */
.tool-grid{display:flex;flex-wrap:wrap;gap:6px}
.tool-chip{padding:5px 10px;background:var(--bg);border-radius:12px;font-size:.72rem;display:flex;align-items:center;gap:4px}
.tool-chip .cnt{background:var(--primary);color:#fff;padding:1px 5px;border-radius:6px;font-size:.6rem;font-weight:600}
.tool-section{margin-bottom:10px}
.tool-label{font-size:.7rem;color:var(--gray);margin-bottom:5px;font-weight:500}

/* =============================================================================
   FREQUENCY CHART (Card B3)
   ============================================================================= */
.freq-chart{display:flex;align-items:flex-end;justify-content:space-around;height:140px;padding-top:20px}
.freq-wrap{display:flex;flex-direction:column;align-items:center;gap:5px}
.freq-bar{width:36px;background:linear-gradient(to top,var(--primary),var(--primary-dark));border-radius:4px 4px 0 0;position:relative;min-height:4px}
.freq-val{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:.7rem;font-weight:600}
.freq-lbl{font-size:.6rem;color:var(--gray);text-align:center;max-width:55px}

/* =============================================================================
   DAILY WORK / RANKING (Card C)
   ============================================================================= */
.work-list{display:flex;flex-direction:column;gap:6px}
.work-item{display:flex;align-items:center;gap:8px}
.work-rank{width:20px;height:20px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:600}
.work-info{flex:1}
.work-name{font-size:.7rem;margin-bottom:2px}
.work-track{height:4px;background:var(--light);border-radius:2px;overflow:hidden}
.work-fill{height:100%;background:var(--primary)}
.work-pct{font-size:.75rem;font-weight:700;color:var(--primary);min-width:35px;text-align:right}

/* =============================================================================
   PROBLEM LIST (Card D1)
   ============================================================================= */
.problem-list{display:flex;flex-direction:column;gap:6px}
.problem-item{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg);border-radius:6px}
.problem-icon{width:26px;height:26px;background:#FFEBEE;color:var(--red);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.8rem}
.problem-name{flex:1;font-size:.75rem}
.problem-cnt{font-size:.9rem;font-weight:700;color:var(--red)}

/* =============================================================================
   THEME GRID (Card D2)
   ============================================================================= */
.theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px}
.theme-card{padding:8px;background:var(--bg);border-radius:6px;display:flex;align-items:center;gap:6px}
.theme-icon{width:28px;height:28px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.9rem}
.theme-name{font-size:.7rem;font-weight:500}
.theme-votes{font-size:.6rem;color:var(--gray)}

/* =============================================================================
   MATRIX (Card D3)
   ============================================================================= */
.matrix{position:relative;width:100%;height:280px;background:linear-gradient(to right,#E3F2FD 50%,#FFF3E0 50%);border-radius:8px;overflow:hidden}
.matrix::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:rgba(0,0,0,.1)}
.matrix::after{content:'';position:absolute;left:50%;top:0;bottom:0;width:1px;background:rgba(0,0,0,.1)}
.quad{position:absolute;font-size:.6rem;font-weight:600;color:var(--gray);opacity:.7}
.quad.tl{top:6px;left:6px}.quad.tr{top:6px;right:6px;text-align:right}.quad.bl{bottom:6px;left:6px}.quad.br{bottom:6px;right:6px;text-align:right}
.bubble{position:absolute;padding:4px 8px;background:#fff;border-radius:12px;font-size:.6rem;box-shadow:0 2px 5px rgba(0,0,0,.15);cursor:pointer;white-space:nowrap;transition:transform .2s}
.bubble:hover{transform:scale(1.1);z-index:10}
.bubble .v{background:var(--primary);color:#fff;padding:1px 4px;border-radius:4px;font-size:.5rem;margin-left:2px}

/* =============================================================================
   RATING TABLE (Card E1)
   ============================================================================= */
.rating-table{width:100%;border-collapse:collapse}
.rating-table th,.rating-table td{padding:8px;text-align:left;border-bottom:1px solid var(--light);font-size:.75rem}
.rating-table th{font-weight:500;color:var(--gray);font-size:.7rem}
.rating-wrap{display:flex;align-items:center;gap:6px}
.rating-bar{flex:1;height:6px;background:var(--light);border-radius:3px;overflow:hidden;max-width:80px}
.rating-fill{height:100%;background:var(--primary)}
.rating-score{font-weight:700;color:var(--primary);min-width:24px}

/* =============================================================================
   IDEAS LIST (Card F)
   ============================================================================= */
.ideas-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto}
.idea-card{padding:10px;background:var(--bg);border-radius:8px;border-left:3px solid var(--primary)}
.idea-header{display:flex;justify-content:space-between;margin-bottom:4px}
.idea-badge{padding:2px 6px;border-radius:8px;font-size:.55rem;font-weight:600;background:var(--accent-light);color:var(--primary)}
.idea-text{font-size:.75rem}

/* =============================================================================
   INSIGHT & RECOMMENDATION PANELS
   ============================================================================= */
.insight-panel{background:linear-gradient(135deg,#E3F2FD,#BBDEFB);border-radius:12px;padding:18px;margin-top:20px}
.insight-panel h4{display:flex;align-items:center;gap:8px;font-size:.9rem;margin-bottom:12px}
.insight-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}
.insight-item{padding:10px;background:#fff;border-radius:6px;font-size:.75rem;display:flex;gap:8px}
.insight-icon{font-size:1rem}

.rec-panel{background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border-radius:12px;padding:18px;margin-top:20px}
.rec-panel h4{display:flex;align-items:center;gap:8px;font-size:.9rem;margin-bottom:12px}
.rec-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
.rec-card{background:#fff;padding:12px;border-radius:8px}
.rec-card h5{font-size:.8rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.rec-card ul{list-style:none}
.rec-card li{padding:3px 0 3px 14px;font-size:.7rem;position:relative}
.rec-card li::before{content:"‚Üí";position:absolute;left:0;color:var(--primary)}

/* =============================================================================
   IMPORT/EXPORT PANEL
   ============================================================================= */
.import-panel{background:#fff;border-radius:12px;padding:18px;margin-top:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.import-panel h4{font-size:.9rem;margin-bottom:12px}
.import-area{display:grid;grid-template-columns:1fr auto;gap:12px}
@media(max-width:600px){.import-area{grid-template-columns:1fr}}
textarea{width:100%;min-height:80px;padding:10px;border:2px dashed var(--light);border-radius:6px;font-family:monospace;font-size:.65rem;resize:vertical}
textarea:focus{outline:none;border-color:var(--primary)}
.import-btns{display:flex;flex-direction:column;gap:6px}
details{margin-top:12px}
summary{cursor:pointer;font-weight:500;font-size:.75rem;color:var(--gray)}
pre{margin-top:8px;padding:10px;background:var(--dark);color:#E0E0E0;border-radius:6px;font-size:.6rem;overflow-x:auto;white-space:pre-wrap}

/* =============================================================================
   FOOTER & UTILITIES
   ============================================================================= */
.footer{text-align:center;padding:20px;color:var(--gray);font-size:.7rem;margin-top:20px}
.toast{position:fixed;bottom:20px;right:20px;padding:10px 18px;background:var(--dark);color:#fff;border-radius:6px;font-size:.8rem;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:1000;display:none}
.toast.success{background:var(--green)}.toast.error{background:var(--red)}
.toast.show{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.empty-state{text-align:center;padding:40px 20px;color:var(--gray)}
.empty-state .empty-icon{font-size:3rem;margin-bottom:10px;opacity:.5}
.empty-state p{font-size:.85rem}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="container">

<!-- =============================================================================
     HEADER
     ============================================================================= -->
<header class="header">
    <div>
        <h1>üèóÔ∏è Standard Performance AI Survey Dashboard</h1>
        <p>Executive View ‚Ä¢ Construction & Engineering ‚Ä¢ ‡∏™‡πÅ‡∏ï‡∏ô‡∏î‡∏≤‡∏£‡πå‡∏î ‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ô‡∏ã‡πå</p>
    </div>
    <div class="header-stats">
        <div class="header-stat"><div class="header-stat-value" id="totalCount">0</div><div class="header-stat-label">‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
        <div class="header-stat"><div class="header-stat-value" id="deptCount">0</div><div class="header-stat-label">‡πÅ‡∏ú‡∏ô‡∏Å</div></div>
        <div class="header-stat"><div class="header-stat-value" id="avgLevel">-</div><div class="header-stat-label">Avg Level</div></div>
    </div>
</header>

<!-- =============================================================================
     STATUS BAR
     ============================================================================= -->
<div class="status-bar">
    <div class="status-item"><div class="status-dot" id="statusDot"></div><span id="statusText">‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span></div>
    <div class="status-item"><span id="lastUpdate">-</span></div>
    <div style="display:flex;gap:8px;"><button class="btn" onclick="fetchFromGoogleSheets()">üîÑ Refresh</button></div>
</div>

<!-- =============================================================================
     FILTER BAR
     ============================================================================= -->
<div class="filter-bar">
    <div class="filter-group"><label>‡πÅ‡∏ú‡∏ô‡∏Å:</label>
        <select id="deptFilter" onchange="render()">
            <option value="all">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
            <option value="project-engineering">üìê ‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</option>
            <option value="architecture">üèõÔ∏è ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå/‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö</option>
            <option value="qs-boq">üìä ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£/‡∏ñ‡∏≠‡∏î‡πÅ‡∏ö‡∏ö</option>
            <option value="site-supervision">üèóÔ∏è ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏á‡∏≤‡∏ô/‡πÇ‡∏ü‡∏£‡πå‡πÅ‡∏°‡∏ô</option>
            <option value="procurement">üõí ‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á</option>
            <option value="warehouse">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡πÇ‡∏ï‡∏£‡πå</option>
            <option value="logistics">üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á/‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå</option>
            <option value="accounting">üí∞ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>
            <option value="hr">üë• ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
            <option value="safety">ü¶∫ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</option>
            <option value="qcqa">‚úÖ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</option>
            <option value="admin">üìã ‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£/‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
            <option value="management">üëî ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
            <option value="it">üíª IT/‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
            <option value="other">üìå ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
    </div>
    <div class="filter-group"><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label><input type="text" id="searchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡πÅ‡∏ú‡∏ô‡∏Å, ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢..." onkeyup="render()"></div>
    <button class="btn sec" onclick="resetFilters()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    <button class="btn" onclick="exportData()">üì• Export</button>
</div>

<!-- =============================================================================
     KPI ROW
     ============================================================================= -->
<div class="kpi-row">
    <div class="kpi"><div class="kpi-value" id="kpiLevel">-</div><div class="kpi-label">Avg AI Readiness</div><div class="kpi-hint" id="kpiLevelHint">-</div></div>
    <div class="kpi green"><div class="kpi-value" id="kpiDaily">-</div><div class="kpi-label">‡πÉ‡∏ä‡πâ AI ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</div><div class="kpi-hint">Active Users</div></div>
    <div class="kpi blue"><div class="kpi-value" id="kpiTool">-</div><div class="kpi-label">Tool ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div><div class="kpi-hint" id="kpiToolPct">-</div></div>
    <div class="kpi orange"><div class="kpi-value" id="kpiPain">-</div><div class="kpi-label">Pain Points</div><div class="kpi-hint warning">‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div></div>
    <div class="kpi red"><div class="kpi-value" id="kpiExpect">-</div><div class="kpi-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div><div class="kpi-hint danger">‡∏™‡∏π‡∏á</div></div>
</div>

<!-- =============================================================================
     MAIN GRID
     ============================================================================= -->
<div class="grid">
    <!-- Card A: Department Snapshot -->
    <div class="card full">
        <div class="card-header"><div class="card-badge">A</div><div class="card-title"><h3>Department Snapshot</h3><p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</p></div></div>
        <div class="card-body"><div class="dept-grid" id="deptSnapshot"></div></div>
    </div>

    <!-- Card B1: AI Readiness Level -->
    <div class="card">
        <div class="card-header"><div class="card-badge">B1</div><div class="card-title"><h3>AI Readiness Level</h3><p>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ AI</p></div></div>
        <div class="card-body"><div class="level-bars" id="levelDist"></div></div>
    </div>

    <!-- Card B2: AI Tools Adoption -->
    <div class="card">
        <div class="card-header"><div class="card-badge">B2</div><div class="card-title"><h3>AI Tools Adoption</h3><p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ AI ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</p></div></div>
        <div class="card-body" id="toolsAdoption"></div>
    </div>

    <!-- Card B3: Usage Frequency -->
    <div class="card">
        <div class="card-header"><div class="card-badge">B3</div><div class="card-title"><h3>Usage Frequency</h3><p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div></div>
        <div class="card-body"><div class="freq-chart" id="freqChart"></div></div>
    </div>

    <!-- Card C: Daily Work Patterns -->
    <div class="card">
        <div class="card-header"><div class="card-badge">C</div><div class="card-title"><h3>Daily Work Patterns</h3><p>‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ö‡πà‡∏≠‡∏¢</p></div></div>
        <div class="card-body"><div class="work-list" id="dailyWorkList"></div></div>
    </div>

    <!-- Card D1: Pain Points -->
    <div class="card">
        <div class="card-header"><div class="card-badge">D1</div><div class="card-title"><h3>Pain Points</h3><p>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢</p></div></div>
        <div class="card-body"><div class="problem-list" id="problemList"></div></div>
    </div>

    <!-- Card D2: AI Help Needed -->
    <div class="card">
        <div class="card-header"><div class="card-badge">D2</div><div class="card-title"><h3>AI Help Needed</h3><p>‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</p></div></div>
        <div class="card-body"><div class="theme-grid" id="aiHelpThemes"></div></div>
    </div>

    <!-- Card D3: Feature Matrix -->
    <div class="card full">
        <div class="card-header"><div class="card-badge">D3</div><div class="card-title"><h3>Interested Features Matrix</h3><p>Impact √ó Effort Analysis</p></div></div>
        <div class="card-body">
            <div class="matrix" id="featureMatrix">
                <div class="quad tl">‚ö° Quick Wins</div>
                <div class="quad tr">üéØ Strategic</div>
                <div class="quad bl">üîß Fill-ins</div>
                <div class="quad br">‚ùì Reconsider</div>
            </div>
        </div>
    </div>

    <!-- Card E1: Expectations Score -->
    <div class="card">
        <div class="card-header"><div class="card-badge">E1</div><div class="card-title"><h3>Expectations Score</h3><p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</p></div></div>
        <div class="card-body"><table class="rating-table" id="expectTable"></table></div>
    </div>

    <!-- Card E2: Interested Topics -->
    <div class="card">
        <div class="card-header"><div class="card-badge">E2</div><div class="card-title"><h3>Interested Topics</h3><p>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p></div></div>
        <div class="card-body"><div class="theme-grid" id="topicsGrid"></div></div>
    </div>

    <!-- Card F: Ideas & Suggestions -->
    <div class="card full">
        <div class="card-header"><div class="card-badge">F</div><div class="card-title"><h3>Ideas & Suggestions</h3><p>‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</p></div></div>
        <div class="card-body"><div class="ideas-list" id="ideasList"></div></div>
    </div>
</div>

<!-- =============================================================================
     INSIGHT PANEL
     ============================================================================= -->
<div class="insight-panel">
    <h4>üí° Key Insights</h4>
    <div class="insight-list" id="insightList"></div>
</div>

<!-- =============================================================================
     RECOMMENDATION PANEL
     ============================================================================= -->
<div class="rec-panel">
    <h4>üéØ Training Recommendations</h4>
    <div class="rec-cards" id="recCards"></div>
</div>

<!-- =============================================================================
     IMPORT/EXPORT PANEL
     ============================================================================= -->
<div class="import-panel">
    <h4>üì• Data Import / Export</h4>
    <div class="import-area">
        <textarea id="importArea" placeholder="‡∏ß‡∏≤‡∏á JSON data ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        <div class="import-btns">
            <button class="btn" onclick="importData()">Import</button>
            <button class="btn sec" onclick="exportData()">Export</button>
        </div>
    </div>
    <details>
        <summary>üìã View Data Schema</summary>
        <pre id="schemaDisplay"></pre>
    </details>
</div>

<footer class="footer">
    <strong>Standard Performance Co., Ltd.</strong> ‚Ä¢ AI Training Survey Dashboard ‚Ä¢ Executive View v1.0
</footer>
</div>

<script>
// =============================================================================
// CONFIG - Google Apps Script URL
// =============================================================================
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzU6SVQgnTrMb7N4xx9VoenNDuNUPWIN0AfrREDLytEoZ4NU0Jr8WXStWgRImWfCugFbQ/exec'; // ‡πÉ‡∏™‡πà URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

// =============================================================================
// DATA SCHEMA (Reference)
// =============================================================================
/*
{
  respondents: [{
    // Section A - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    name: string,                    // ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
    position: string,                // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    department: string,              // ‡πÅ‡∏ú‡∏ô‡∏Å (project-engineering/architecture/qs-boq/site-supervision/procurement/warehouse/logistics/accounting/hr/safety/qcqa/admin/management/it/other)
    departmentOther: string,         // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å other
    currentProject: string,          // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    
    // Section B - ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå AI
    experienceLevel: number,         // 0-5
    toolsUsed: string[],             // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ AI ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
    usageFrequency: string,          // never/monthly/weekly/multiple-weekly/daily
    
    // Section C - ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥
    dailyWork: {
      engineering: string[],         // ‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°
      estimation: string[],          // ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£
      warehouse: string[],           // ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
      accounting: string[],          // ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
      admin: string[]                // ‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£
    },
    repeatWork: string[],            // ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ö‡πà‡∏≠‡∏¢
    
    // Section D - ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    problems: {
      dataSilo: string[],            // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Data Silo
      document: string[],            // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
      procurement: string[],         // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠
      siteRecording: string[],       // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô
      security: string[]             // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    },
    painPoints: string[],            // Pain points ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    aiHelpTop3: string[],            // ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢ Top 3
    interestedFeatures: {
      document: string[],            // Feature ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
      procurement: string[],         // Feature ‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠
      projectTracking: string[],     // Feature ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
      warehouse: string[],           // Feature ‡∏Ñ‡∏•‡∏±‡∏á
      technical: string[],           // Feature ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ
      communication: string[]        // Feature ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
    },
    
    // Section E - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á
    expectationsScore: {
      understandAI: number,          // 1-5
      speedUpWork: number,
      analyzeData: number,
      promptEngineering: number,
      constructionAI: number,
      dataSecurity: number,
      reduceManual: number,
      aiForReport: number,
      otherTopic: string,
      otherScore: number
    },
    interestedTopics: string[],
    
    // Section F - ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞
    keySuccess: string[],            // Key Success Factors
    creativity: string[],            // ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå
    concerns: string,                // ‡∏Ç‡πâ‡∏≠‡∏Å‡∏±‡∏á‡∏ß‡∏•
    speakerNotes: string,            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡∏∂‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£
    
    timestamp: string                // ISO timestamp
  }]
}
*/

// =============================================================================
// DATA (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)
// =============================================================================
let DATA = { respondents: [] };

const SCHEMA_DISPLAY = `{
  respondents: [{
    name, position, department, departmentOther, currentProject,
    experienceLevel (0-5),
    toolsUsed[],
    usageFrequency (never/monthly/weekly/multiple-weekly/daily),
    dailyWork: { engineering[], estimation[], warehouse[], accounting[], admin[] },
    repeatWork[],
    problems: { dataSilo[], document[], procurement[], siteRecording[], security[] },
    painPoints[],
    aiHelpTop3[],
    interestedFeatures: { document[], procurement[], projectTracking[], warehouse[], technical[], communication[] },
    expectationsScore: { understandAI, speedUpWork, analyzeData, promptEngineering, 
                         constructionAI, dataSecurity, reduceManual, aiForReport },
    interestedTopics[],
    keySuccess[], creativity[],
    concerns, speakerNotes,
    timestamp
  }]
}`;

// =============================================================================
// LABELS
// =============================================================================
const DEPT_LABELS = {
    'project-engineering': 'üìê ‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£',
    'architecture': 'üèõÔ∏è ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå',
    'qs-boq': 'üìä ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£',
    'site-supervision': 'üèóÔ∏è ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏á‡∏≤‡∏ô',
    'procurement': 'üõí ‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠',
    'warehouse': 'üì¶ ‡∏Ñ‡∏•‡∏±‡∏á',
    'logistics': 'üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á',
    'accounting': 'üí∞ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
    'hr': 'üë• HR',
    'safety': 'ü¶∫ Safety',
    'qcqa': '‚úÖ QC/QA',
    'admin': 'üìã Admin',
    'management': 'üëî Management',
    'it': 'üíª IT',
    'other': 'üìå ‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
};

const LEVEL_LABELS = ['‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢','‡πÄ‡∏Ñ‡∏¢‡∏•‡∏≠‡∏á 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏≤‡∏ß','‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞ 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô','‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å'];
const LEVEL_COLORS = ['#E0E0E0','#FFCDD2','#FFAB91','#FFE082','#A5D6A7','#4CAF50'];
const FREQ_MAP = { daily:'‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô', 'multiple-weekly':'‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', weekly:'‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á', monthly:'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á', never:'‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢' };

const EXPECT_LABELS = {
    understandAI: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à AI ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô',
    speedUpWork: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô',
    analyzeData: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    promptEngineering: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Prompt ‡πÄ‡∏Å‡πà‡∏á',
    constructionAI: 'AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á',
    dataSecurity: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    reduceManual: '‡∏•‡∏î‡∏á‡∏≤‡∏ô Manual',
    aiForReport: 'AI ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'
};

// =============================================================================
// GOOGLE SHEETS FETCH
// =============================================================================
async function fetchFromGoogleSheets() {
    if (!GOOGLE_SCRIPT_URL) {
        updateStatus('offline');
        toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GOOGLE_SCRIPT_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î', 'error');
        return;
    }
    updateStatus('loading');
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL);
        const json = await response.json();
        if (json.respondents && json.respondents.length > 0) {
            DATA = json;
            render();
            updateStatus('online');
            toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ' + DATA.respondents.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'success');
        } else if (json.error) {
            throw new Error(json.error);
        } else {
            updateStatus('online');
            toast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets', '');
            render();
        }
    } catch (error) {
        console.error('Fetch error:', error);
        updateStatus('error');
        toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message, 'error');
    }
}

function updateStatus(status) {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    const update = document.getElementById('lastUpdate');
    dot.className = 'status-dot';
    if (status === 'online') { dot.classList.add('online'); text.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß'; }
    else if (status === 'loading') { dot.classList.add('loading'); text.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'; }
    else if (status === 'error') { dot.classList.add('error'); text.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'; }
    else { text.textContent = '‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'; }
    update.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó: ' + new Date().toLocaleTimeString('th-TH');
}

// =============================================================================
// HELPERS
// =============================================================================
function getFiltered() {
    const dept = document.getElementById('deptFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    return DATA.respondents.filter(r => {
        const deptMatch = dept === 'all' || r.department === dept;
        const searchMatch = !search || 
            (r.name && r.name.toLowerCase().includes(search)) ||
            (r.position && r.position.toLowerCase().includes(search)) ||
            (r.department && r.department.toLowerCase().includes(search)) ||
            (r.creativity && r.creativity.join(' ').toLowerCase().includes(search)) ||
            (r.concerns && r.concerns.toLowerCase().includes(search));
        return deptMatch && searchMatch;
    });
}

function countBy(arr, key) { 
    const c = {}; 
    arr.forEach(i => { 
        const v = typeof key === 'function' ? key(i) : i[key]; 
        if (v != null) c[v] = (c[v] || 0) + 1; 
    }); 
    return c; 
}

function flatCount(arr, key) { 
    const c = {}; 
    arr.forEach(i => { 
        const items = i[key]; 
        if (Array.isArray(items)) items.forEach(v => { if (v) c[v] = (c[v] || 0) + 1; }); 
    }); 
    return c; 
}

function flatCountNested(arr, key) { 
    const c = {}; 
    arr.forEach(i => { 
        const obj = i[key]; 
        if (obj && typeof obj === 'object') {
            Object.values(obj).forEach(items => { 
                if (Array.isArray(items)) items.forEach(v => { if (v) c[v] = (c[v] || 0) + 1; }); 
            }); 
        }
    }); 
    return c; 
}

function avg(arr, key) { 
    if (!arr.length) return 0; 
    return arr.reduce((s, i) => s + (typeof key === 'function' ? key(i) : (i[key] || 0)), 0) / arr.length; 
}

function sortObj(obj) { return Object.entries(obj).sort((a, b) => b[1] - a[1]); }

function toast(msg, type = '') { 
    const t = document.getElementById('toast'); 
    t.textContent = msg; 
    t.className = 'toast show ' + (type || ''); 
    setTimeout(() => t.classList.remove('show'), 3000); 
}

function emptyState(msg = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') { 
    return `<div class="empty-state"><div class="empty-icon">üì≠</div><p>${msg}</p></div>`; 
}

// =============================================================================
// RENDER
// =============================================================================
function render() {
    const d = getFiltered();
    const hasData = d.length > 0;

    // Header Stats
    document.getElementById('totalCount').textContent = d.length;
    const uniqueDepts = [...new Set(d.map(r => r.department).filter(Boolean))];
    document.getElementById('deptCount').textContent = uniqueDepts.length || '-';
    const avgLvl = hasData ? avg(d, r => r.experienceLevel || 0) : 0;
    document.getElementById('avgLevel').textContent = hasData ? 'L' + avgLvl.toFixed(1) : '-';

    // KPIs
    document.getElementById('kpiLevel').textContent = hasData ? avgLvl.toFixed(1) : '-';
    const lvlCounts = countBy(d, 'experienceLevel');
    document.getElementById('kpiLevelHint').textContent = hasData ? sortObj(lvlCounts).slice(0, 2).map(x => 'L' + x[0]).join(' & ') || '-' : '-';
    
    const dailyPct = hasData ? Math.round((d.filter(r => r.usageFrequency === 'daily').length / d.length) * 100) : 0;
    document.getElementById('kpiDaily').textContent = hasData ? dailyPct + '%' : '-';
    
    const tools = flatCount(d, 'toolsUsed');
    const topTool = sortObj(tools)[0];
    document.getElementById('kpiTool').textContent = topTool ? topTool[0].split(' ')[0] : '-';
    document.getElementById('kpiToolPct').textContent = topTool ? Math.round(topTool[1] / d.length * 100) + '% ‡πÉ‡∏ä‡πâ' : '-';
    
    const problems = flatCountNested(d, 'problems');
    document.getElementById('kpiPain').textContent = hasData ? Object.keys(problems).length : '-';
    
    const expectKeys = Object.keys(EXPECT_LABELS);
    const avgExp = hasData ? expectKeys.reduce((s, k) => s + avg(d, r => (r.expectationsScore || {})[k] || 0), 0) / expectKeys.length : 0;
    document.getElementById('kpiExpect').textContent = hasData ? avgExp.toFixed(1) : '-';

    // Card A: Department Snapshot
    const deptCounts = countBy(d, 'department');
    document.getElementById('deptSnapshot').innerHTML = hasData ? sortObj(deptCounts).map(([dept, count]) => `
        <div class="dept-card"><div class="dept-name">${DEPT_LABELS[dept] || dept}</div><div class="dept-count">${count}</div></div>
    `).join('') : emptyState('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°');

    // Card B1: Level Distribution
    document.getElementById('levelDist').innerHTML = [0,1,2,3,4,5].map(l => {
        const cnt = lvlCounts[l] || 0;
        const pct = hasData ? Math.round(cnt / d.length * 100) : 0;
        return `<div class="level-item"><div class="level-badge l${l}">L${l}</div><div class="level-info"><div class="level-top"><span>${LEVEL_LABELS[l]}</span><span class="level-count">${cnt} ‡∏Ñ‡∏ô (${pct}%)</span></div><div class="level-track"><div class="level-fill" style="width:${pct}%;background:${LEVEL_COLORS[l]}"></div></div></div></div>`;
    }).join('');

    // Card B2: Tools
    const toolCnt = flatCount(d, 'toolsUsed');
    const genAI = ['ChatGPT (OpenAI)', 'Google Gemini / Bard', 'Claude (Anthropic)', 'Microsoft Copilot'];
    const msTools = ['Microsoft 365 Copilot', 'Excel AI', 'PowerPoint AI'];
    const otherAI = ['LINE AI / OA', 'AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û', 'AI ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/OCR', 'AI ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤'];
    const renderTools = list => list.map(t => `<div class="tool-chip">${t.split(' ')[0]}<span class="cnt">${toolCnt[t] || 0}</span></div>`).join('');
    document.getElementById('toolsAdoption').innerHTML = `
        <div class="tool-section"><div class="tool-label">ü§ñ Generative AI</div><div class="tool-grid">${renderTools(genAI)}</div></div>
        <div class="tool-section"><div class="tool-label">üìä Microsoft 365</div><div class="tool-grid">${renderTools(msTools)}</div></div>
        <div class="tool-section"><div class="tool-label">üîß Others</div><div class="tool-grid">${renderTools(otherAI)}</div></div>
    `;

    // Card B3: Frequency
    const freqCnt = countBy(d, 'usageFrequency');
    const maxFreq = Math.max(...Object.values(freqCnt), 1);
    document.getElementById('freqChart').innerHTML = Object.entries(FREQ_MAP).map(([k, l]) => {
        const cnt = freqCnt[k] || 0;
        const h = hasData ? Math.round(cnt / maxFreq * 100) : 0;
        return `<div class="freq-wrap"><div class="freq-bar" style="height:${h}px"><span class="freq-val">${cnt}</span></div><div class="freq-lbl">${l}</div></div>`;
    }).join('');

    // Card C: Daily Work
    const dailyWorkAll = flatCountNested(d, 'dailyWork');
    const repeatWorkAll = flatCount(d, 'repeatWork');
    const combinedWork = { ...dailyWorkAll };
    Object.entries(repeatWorkAll).forEach(([k, v]) => combinedWork[k] = (combinedWork[k] || 0) + v);
    const topDailyWork = sortObj(combinedWork).slice(0, 8);
    const maxWork = topDailyWork[0] ? topDailyWork[0][1] : 1;
    document.getElementById('dailyWorkList').innerHTML = topDailyWork.length ? topDailyWork.map(([name, count], i) => `
        <div class="work-item"><div class="work-rank">${i + 1}</div><div class="work-info"><div class="work-name">${name}</div><div class="work-track"><div class="work-fill" style="width:${count / maxWork * 100}%"></div></div></div><div class="work-pct">${count}</div></div>
    `).join('') : emptyState();

    // Card D1: Problems
    const problemList = sortObj(flatCountNested(d, 'problems')).slice(0, 6);
    document.getElementById('problemList').innerHTML = problemList.length ? problemList.map(([n, c]) => `
        <div class="problem-item"><div class="problem-icon">‚ö†Ô∏è</div><div class="problem-name">${n}</div><div class="problem-cnt">${c}</div></div>
    `).join('') : emptyState();

    // Card D2: AI Help
    const helpThemes = sortObj(flatCount(d, 'aiHelpTop3')).slice(0, 8);
    const icons = ['ü§ñ','üìä','üìù','üöÄ','üí°','üìà','üîç','‚ú®'];
    document.getElementById('aiHelpThemes').innerHTML = helpThemes.length ? helpThemes.map(([n, c], i) => `
        <div class="theme-card"><div class="theme-icon">${icons[i % 8]}</div><div><div class="theme-name">${n}</div><div class="theme-votes">${c} ‡∏Ñ‡∏ô</div></div></div>
    `).join('') : emptyState();

    // Card D3: Features Matrix
    const features = sortObj(flatCountNested(d, 'interestedFeatures'));
    const matrix = document.getElementById('featureMatrix');
    matrix.querySelectorAll('.bubble').forEach(b => b.remove());
    features.slice(0, 12).forEach(([n, c]) => {
        const impact = 0.3 + Math.random() * 0.4;
        const effort = 0.2 + Math.random() * 0.6;
        const b = document.createElement('div');
        b.className = 'bubble';
        b.style.left = (effort * 85 + 7) + '%';
        b.style.top = ((1 - impact) * 85 + 7) + '%';
        b.innerHTML = `${n.substring(0, 20)}<span class="v">${c}</span>`;
        matrix.appendChild(b);
    });

    // Card E1: Expectations
    document.getElementById('expectTable').innerHTML = `<thead><tr><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody>${Object.entries(EXPECT_LABELS).map(([k, l]) => {
        const a = avg(d, r => (r.expectationsScore || {})[k] || 0);
        return `<tr><td>${l}</td><td><div class="rating-wrap"><div class="rating-bar"><div class="rating-fill" style="width:${a * 20}%"></div></div><span class="rating-score">${hasData ? a.toFixed(1) : '-'}</span></div></td></tr>`;
    }).join('')}</tbody>`;

    // Card E2: Topics
    const topics = sortObj(flatCount(d, 'interestedTopics')).slice(0, 8);
    const topicIcons = ['üìö','üíª','üéØ','üìà','üîß','üåü','üß†','üöÄ'];
    document.getElementById('topicsGrid').innerHTML = topics.length ? topics.map(([n, c], i) => `
        <div class="theme-card"><div class="theme-icon">${topicIcons[i % 8]}</div><div><div class="theme-name">${n}</div><div class="theme-votes">${c} ‡∏Ñ‡∏ô</div></div></div>
    `).join('') : emptyState();

    // Card F: Ideas
    const ideas = d.filter(r => (r.creativity && r.creativity.length) || r.concerns || r.speakerNotes);
    document.getElementById('ideasList').innerHTML = ideas.length ? ideas.slice(0, 15).map(r => {
        const creativityText = r.creativity ? r.creativity.join(', ') : '';
        return `
            <div class="idea-card">
                <div class="idea-header">
                    <span class="idea-badge">${DEPT_LABELS[r.department] || r.department || '-'}</span>
                    <span style="font-size:.65rem;color:var(--gray)">${r.name || '-'} ‚Ä¢ ${r.position || ''}</span>
                </div>
                <div class="idea-text">
                    ${creativityText ? 'üí° ' + creativityText : ''}
                    ${r.concerns ? '<br><span style="color:var(--orange)">‚ö†Ô∏è ' + r.concerns + '</span>' : ''}
                    ${r.speakerNotes ? '<br><em style="color:var(--gray)">[Note: ' + r.speakerNotes + ']</em>' : ''}
                </div>
            </div>
        `;
    }).join('') : emptyState();

    // Insight Panel
    const topProblem = problemList[0] ? problemList[0][0] : '-';
    const topHelp = helpThemes[0] ? helpThemes[0][0] : '-';
    const l0l1Pct = hasData ? Math.round(((lvlCounts[0] || 0) + (lvlCounts[1] || 0)) / d.length * 100) : 0;
    const insights = hasData ? [
        { icon: 'üìä', text: `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ L${avgLvl.toFixed(1)} - ${avgLvl < 2 ? '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô' : avgLvl < 3.5 ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î' : '‡∏ó‡∏µ‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á'}` },
        { icon: 'üî•', text: `${dailyPct}% ‡πÉ‡∏ä‡πâ AI ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô - ${dailyPct < 20 ? '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : dailyPct < 50 ? '‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•' : 'Adoption ‡∏™‡∏π‡∏á'}` },
        { icon: '‚ö†Ô∏è', text: `Pain Point ‡∏´‡∏•‡∏±‡∏Å: "${topProblem}"` },
        { icon: 'üí°', text: `‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î: "${topHelp}"` },
        { icon: 'üéØ', text: `${l0l1Pct}% ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ/‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≠‡∏¢ (L0-L1) - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ô‡πâ‡∏ô Hands-on` },
        { icon: 'üìà', text: `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgExp.toFixed(1)}/5` }
    ] : [{ icon: 'üì≠', text: '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°' }];
    document.getElementById('insightList').innerHTML = insights.map(ins => `<div class="insight-item"><span class="insight-icon">${ins.icon}</span><span>${ins.text}</span></div>`).join('');

    // Recommendation Panel
    const recs = [
        { title: 'üéì Track 1: AI Foundation', items: ['‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö L0-L1', 'AI ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ', 'Hands-on: ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ ChatGPT', 'Use Case ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á'] },
        { title: 'üöÄ Track 2: Prompt Engineering', items: ['‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö L2-L3', '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Prompt', 'Workshop ‡∏ñ‡∏≠‡∏î‡πÅ‡∏ö‡∏ö/‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£', 'Best Practices ‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'] },
        { title: 'üéØ Track 3: AI for Construction', items: ['‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö L3-L5', 'AI ‡∏ä‡πà‡∏ß‡∏¢‡∏ñ‡∏≠‡∏î‡πÅ‡∏ö‡∏ö BOQ', 'AI ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô', 'AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] }
    ];
    document.getElementById('recCards').innerHTML = recs.map(r => `<div class="rec-card"><h5>${r.title}</h5><ul>${r.items.map(i => `<li>${i}</li>`).join('')}</ul></div>`).join('');
}

// =============================================================================
// ACTIONS
// =============================================================================
function resetFilters() { 
    document.getElementById('deptFilter').value = 'all'; 
    document.getElementById('searchInput').value = ''; 
    render(); 
}

function importData() {
    try {
        const json = document.getElementById('importArea').value;
        if (!json.trim()) { toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á JSON', 'error'); return; }
        const parsed = JSON.parse(json);
        if (parsed.respondents) DATA = parsed;
        else if (Array.isArray(parsed)) DATA = { respondents: parsed };
        else throw new Error('Invalid format');
        render();
        toast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ' + DATA.respondents.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'success');
    } catch (e) { toast('JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ' + e.message, 'error'); }
}

function exportData() {
    const json = JSON.stringify(DATA, null, 2);
    navigator.clipboard.writeText(json).then(() => toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß', 'success')).catch(() => {
        const blob = new Blob([json], { type: 'application/json' });
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = 'standard_performance_survey_data.json'; 
        a.click();
        toast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON ‡πÅ‡∏•‡πâ‡∏ß', 'success');
    });
}

// =============================================================================
// INIT
// =============================================================================
document.getElementById('schemaDisplay').textContent = SCHEMA_DISPLAY;
render();
if (GOOGLE_SCRIPT_URL) fetchFromGoogleSheets();
</script>
</body>
</html>
